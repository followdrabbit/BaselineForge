# Processed Content from URL: {'REFERENCE': 'https://aws.amazon.com/pt/blogs/networking-and-content-delivery/security-best-practices-when-using-alb-authentication/'}

Skip to Main Content

[Click here to return to Amazon Web Services
homepage](https://aws.amazon.com/?nc2=h_lg)

[About AWS](https://aws.amazon.com/about-aws/?nc2=h_header) [Contact
Us](https://aws.amazon.com/contact-us/?nc2=h_header) Support   English   My
Account  

[ Sign In](https://console.aws.amazon.com/console/home?nc2=h_ct&src=header-
signin)

[ Create an AWS Account
](https://portal.aws.amazon.com/gp/aws/developer/registration/index.html?nc2=h_ct&src=header_signup)

__

  * [Amazon Q](https://aws.amazon.com/q/?nc2=h_ql_prod_l1_q)
  * [Products](https://aws.amazon.com/products/?nc2=h_ql_prod)
  * [Solutions](https://aws.amazon.com/solutions/?nc2=h_ql_sol)
  * [Pricing](https://aws.amazon.com/pricing/?nc2=h_ql_pr)
  * [Documentation](https://aws.amazon.com/documentation-overview/?nc2=h_ql_doc_do)
  * [Learn](https://aws.amazon.com/getting-started/?nc2=h_ql_le)
  * [Partner Network](https://aws.amazon.com/partners/?nc2=h_ql_pn)
  * [AWS Marketplace](https://aws.amazon.com/marketplace/?nc2=h_ql_mp)
  * [Customer Enablement](https://aws.amazon.com/customer-enablement/?nc2=h_ql_ce)
  * [Events](https://aws.amazon.com/events/?nc2=h_ql_ev)
  * [Explore More ](https://aws.amazon.com/contact-us/?nc2=h_ql_exm)

__

__

Close

  * [عربي](https://aws.amazon.com/ar/?nc1=h_ls)
  * [Bahasa Indonesia](https://aws.amazon.com/id/?nc1=h_ls)
  * [Deutsch](https://aws.amazon.com/de/?nc1=h_ls)
  * [English](https://aws.amazon.com/?nc1=h_ls)
  * [Español](https://aws.amazon.com/es/?nc1=h_ls)
  * [Français](https://aws.amazon.com/fr/?nc1=h_ls)
  * [Italiano](https://aws.amazon.com/it/?nc1=h_ls)
  * [Português](https://aws.amazon.com/pt/?nc1=h_ls)

  * [Tiếng Việt](https://aws.amazon.com/vi/?nc1=f_ls)
  * [Türkçe](https://aws.amazon.com/tr/?nc1=h_ls)
  * [Ρусский](https://aws.amazon.com/ru/?nc1=h_ls)
  * [ไทย](https://aws.amazon.com/th/?nc1=f_ls)
  * [日本語](https://aws.amazon.com/jp/?nc1=h_ls)
  * [한국어](https://aws.amazon.com/ko/?nc1=h_ls)
  * [中文 (简体)](https://aws.amazon.com/cn/?nc1=h_ls)
  * [中文 (繁體)](https://aws.amazon.com/tw/?nc1=h_ls)

Close

  * [My Profile](https://aws.amazon.com/profile/?nc2=h_m_mc)
  * [Sign out of AWS Builder ID](https://auth.aws.amazon.com/sign-out/?nc2=h_m_mc)
  * [AWS Management Console](https://console.aws.amazon.com/?nc2=h_m_mc)
  * [Account Settings](https://console.aws.amazon.com/billing/home#/account?nc2=h_m_ma)
  * [Billing & Cost Management](https://console.aws.amazon.com/billing/home?nc2=h_m_bc)
  * [Security Credentials](https://console.aws.amazon.com/iam/home?nc2=h_m_sc#security_credential)
  * [AWS Personal Health Dashboard](https://phd.aws.amazon.com/?nc2=h_m_sc)

Close

  * [Support Center](https://console.aws.amazon.com/support/home/?nc2=h_ql_cu)
  * [Expert Help](https://iq.aws.amazon.com/?utm=mkt.nav)
  * [Knowledge Center](https://repost.aws/knowledge-center/?nc2=h_m_ma)
  * [AWS Support Overview](https://aws.amazon.com/premiumsupport/?nc2=h_m_bc)
  * [AWS re:Post](https://repost.aws/)

[Click here to return to Amazon Web Services
homepage](https://aws.amazon.com/?nc2=h_lg)

[ Get Started for Free
](https://portal.aws.amazon.com/gp/aws/developer/registration/index.html?nc2=h_mobile)

[ Contact Us ](https://aws.amazon.com/contact-us/?nc2=h_mobile)

  * [Products](https://aws.amazon.com/products/?nc2=h_mo)
  * [Solutions](https://aws.amazon.com/solutions/?nc2=h_mo)
  * [Pricing](https://aws.amazon.com/pricing/?nc2=h_mo)
  * [Introduction to AWS](https://aws.amazon.com/what-is-aws/?nc2=h_mo)
  * [Getting Started](https://aws.amazon.com/getting-started/?nc2=h_mo)
  * [Documentation](https://aws.amazon.com/documentation-overview/?nc2=h_mo)
  * [Training and Certification](https://aws.amazon.com/training/?nc2=h_mo)
  * [Developer Center](https://aws.amazon.com/developer/?nc2=h_mo)
  * [Customer Success](https://aws.amazon.com/solutions/case-studies/?nc2=h_mo)
  * [Partner Network](https://aws.amazon.com/partners/?nc2=h_mo)
  * [AWS Marketplace](https://aws.amazon.com/marketplace/?nc2=h_mo)
  * [Support](https://console.aws.amazon.com/support/home?nc2=h_ql_cu)
  * [AWS re:Post](https://repost.aws/)
  * [Log into Console](https://console.aws.amazon.com/console/home)
  * [Download the Mobile App](https://aws.amazon.com/console/mobile/)

[ AWS Blog Home](/blogs) Blogs  __ Editions  __

Close

[ Architecture](https://aws.amazon.com/blogs/architecture/) [ AWS Cloud
Operations](https://aws.amazon.com/blogs/mt/) [ AWS for
Games](https://aws.amazon.com/blogs/gametech/) [ AWS
Insights](https://aws.amazon.com/blogs/aws-insights/) [ AWS
Marketplace](https://aws.amazon.com/blogs/awsmarketplace/) [ AWS
News](https://aws.amazon.com/blogs/aws/) [ AWS Partner
Network](https://aws.amazon.com/blogs/apn/) [ AWS Smart
Business](https://aws.amazon.com/blogs/smb/) [ Big
Data](https://aws.amazon.com/blogs/big-data/) [ Business
Intelligence](https://aws.amazon.com/blogs/business-intelligence/) [ Business
Productivity](https://aws.amazon.com/blogs/business-productivity/) [ Cloud
Enterprise Strategy](https://aws.amazon.com/blogs/enterprise-strategy/) [
Cloud Financial Management](https://aws.amazon.com/blogs/aws-cloud-financial-
management/) [ Compute](https://aws.amazon.com/blogs/compute/) [ Contact
Center](https://aws.amazon.com/blogs/contact-center/) [
Containers](https://aws.amazon.com/blogs/containers/) [
Database](https://aws.amazon.com/blogs/database/) [ Desktop & Application
Streaming](https://aws.amazon.com/blogs/desktop-and-application-streaming/) [
Developer Tools](https://aws.amazon.com/blogs/developer/) [ DevOps & Developer
Productivity](https://aws.amazon.com/blogs/devops/) [ Front-End Web &
Mobile](https://aws.amazon.com/blogs/mobile/)

[ HPC](https://aws.amazon.com/blogs/hpc/) [ IBM and Red
Hat](https://aws.amazon.com/blogs/ibm-redhat/) [
Industries](https://aws.amazon.com/blogs/industries/) [ Integration &
Automation](https://aws.amazon.com/blogs/infrastructure-and-automation/) [
Internet of Things](https://aws.amazon.com/blogs/iot/) [ Machine
Learning](https://aws.amazon.com/blogs/machine-learning/) [
Media](https://aws.amazon.com/blogs/media/) [ Messaging &
Targeting](https://aws.amazon.com/blogs/messaging-and-targeting/) [ Microsoft
Workloads on AWS](https://aws.amazon.com/blogs/modernizing-with-aws/) [
Migration and Modernization](https://aws.amazon.com/blogs/migration-and-
modernization/) [ .NET on AWS](https://aws.amazon.com/blogs/dotnet/) [
Networking & Content Delivery](https://aws.amazon.com/blogs/networking-and-
content-delivery/) [ Open Source](https://aws.amazon.com/blogs/opensource/) [
Public Sector](https://aws.amazon.com/blogs/publicsector/) [ Quantum
Computing](https://aws.amazon.com/blogs/quantum-computing/) [
Robotics](https://aws.amazon.com/blogs/robotics/) [
SAP](https://aws.amazon.com/blogs/awsforsap/) [
Security](https://aws.amazon.com/security/blogs/) [ Spatial
Computing](https://aws.amazon.com/blogs/spatial/) [
Startups](https://aws.amazon.com/blogs/startups/) [
Storage](https://aws.amazon.com/blogs/storage/) [ Supply Chain &
Logistics](https://aws.amazon.com/blogs/supply-chain/) [ Training &
Certification](https://aws.amazon.com/blogs/training-and-certification/)

Close

  * [中国版](https://aws.amazon.com/cn/blogs/china/)
  * [日本版](https://aws.amazon.com/jp/blogs/news/)
  * [한국 에디션](https://aws.amazon.com/ko/blogs/korea/)
  * [기술 블로그](https://aws.amazon.com/ko/blogs/tech/)
  * [Edisi Bahasa Indonesia](https://aws.amazon.com/id/blogs/indonesia/)
  * [AWS Thai Blog](https://aws.amazon.com/th/blogs/thailand/)
  * [Édition Française](https://aws.amazon.com/fr/blogs/france/)
  * [Deutsche Edition](https://aws.amazon.com/de/blogs/germany/)
  * [Edição em Português](https://aws.amazon.com/pt/blogs/aws-brasil/)
  * [Edición en Español](https://aws.amazon.com/es/blogs/aws-spanish/)
  * [Версия на русском](https://aws.amazon.com/ru/blogs/rus/)
  * [Türkçe Sürüm](https://aws.amazon.com/tr/blogs/turkey/)

## [Networking & Content Delivery](https://aws.amazon.com/blogs/networking-
and-content-delivery/)

# Security best practices when using ALB authentication

by Lucas Pellucci Barreto Rolim and Luis Felipe Silveira da Silva on 15 AUG
2024 in [Amazon Cognito](https://aws.amazon.com/blogs/networking-and-content-
delivery/category/security-identity-compliance/amazon-cognito/ "View all posts
in Amazon Cognito"), [Best Practices](https://aws.amazon.com/blogs/networking-
and-content-delivery/category/post-types/best-practices/ "View all posts in
Best Practices"), [Elastic Load
Balancing](https://aws.amazon.com/blogs/networking-and-content-
delivery/category/networking-content-delivery/elastic-load-balancing/ "View
all posts in Elastic Load Balancing"), [Networking & Content
Delivery](https://aws.amazon.com/blogs/networking-and-content-
delivery/category/networking-content-delivery/ "View all posts in Networking &
Content Delivery"), [Security, Identity, &
Compliance](https://aws.amazon.com/blogs/networking-and-content-
delivery/category/security-identity-compliance/ "View all posts in Security,
Identity, & Compliance") [Permalink](https://aws.amazon.com/blogs/networking-
and-content-delivery/security-best-practices-when-using-alb-authentication/)
Share

  * [](https://www.facebook.com/sharer/sharer.php?u=https://aws.amazon.com/blogs/networking-and-content-delivery/security-best-practices-when-using-alb-authentication/)
  * [](https://twitter.com/intent/tweet/?text=Security%20best%20practices%20when%20using%20ALB%20authentication&via=awscloud&url=https://aws.amazon.com/blogs/networking-and-content-delivery/security-best-practices-when-using-alb-authentication/)
  * [](https://www.linkedin.com/shareArticle?mini=true&title=Security%20best%20practices%20when%20using%20ALB%20authentication&source=Amazon%20Web%20Services&url=https://aws.amazon.com/blogs/networking-and-content-delivery/security-best-practices-when-using-alb-authentication/)
  * [](mailto:?subject=Security%20best%20practices%20when%20using%20ALB%20authentication&body=Security%20best%20practices%20when%20using%20ALB%20authentication%0A%0Ahttps://aws.amazon.com/blogs/networking-and-content-delivery/security-best-practices-when-using-alb-authentication/)
  * 

At AWS, security is the top priority, and we are committed to providing you
with the necessary guidance to fortify the security posture of your
environment. In 2018, we introduced built-in [authentication
support](https://aws.amazon.com/blogs/aws/built-in-authentication-in-alb/) for
[Application Load Balancers
(ALBs)](https://aws.amazon.com/elasticloadbalancing/application-load-
balancer/), enabling secure user authentication as they access applications.
This feature allows developers to offload the authentication responsibility
from the backend target, which eliminates the need for writing complex
authentication code and simplifying the application development process. To
maintain a robust security environment, it is crucial to make sure that your
applications and targets are correctly configured.

In the Amazon Web Services (AWS) [shared responsibility
model](https://aws.amazon.com/compliance/shared-responsibility-model/), AWS is
responsible for the ‘Security of the Cloud,’ encompassing the security aspects
of the underlying infrastructure and services, including the load balancer
software itself. Specifically, AWS makes sure of the secure operation of the
authentication mechanisms used by the ALB. On the other hand, users are
responsible for ‘Security in the Cloud,’ which refers to the secure
configuration of the resources they provision and use. This includes
configuring parameters related to the ALB’s authentication feature, security
group settings for target resources, and secure configuration of software
running on target resources behind the ALB. Although the ALB handles request
authentication, users must configure their application to process requests
originating from the ALB securely.

In this post, we share our best practices to help you use the authentication
capabilities of ALBs effectively and also make sure that robust security
measures are in place. We dive deep into the best practices for enhancing the
security of your environment with ALB authentication. Together, we can build a
more secure and resilient digital ecosystem, safeguarding your data and
applications from potential threats.

## ALB authentication configuration

When configuring authentication, you set up an authenticate action for one or
more listener rules. The _authenticate-cognito_ and _authenticate-oidc_ action
types are supported only with HTTPS listeners, because authentication cannot
be used for non TLS HTTP workloads. This is an example of a listener default
rule:

    
    
            "Priority": "default",
            "Conditions": [],
            "RuleArn": "arn:aws:elasticloadbalancing:<REGION>:<ACCOUNT-ID>:listener-rule/app/alb/AAA/BBB/CCC",
            "IsDefault": true,
            "Actions": [
                {
                    "AuthenticateOidcConfig": {
                        "OnUnauthenticatedRequest": "authenticate",
                        "TokenEndpoint": "https://<YOUR_TOKEN_ENDPOINT>/<PATH>",
                        "ClientId": "<YOUR_CLIENT_ID>",
                        "SessionTimeout": 604800,
                        "AuthorizationEndpoint": "https://<YOUR_AUTHORIZATION_ENDPOINT>/<PATH>",
                        "Scope": "openid",
                        "SessionCookieName": "AWSELBAuthSessionCookie",
                        "UserInfoEndpoint": "https://<YOUR_USERINFO_ENDPOINT>/<PATH>",
                        "Issuer": "https://<YOUR_ISSUER_ENDPOINT>/<PATH>"
                    },
                    "Type": "authenticate-oidc",
                    "Order": 1
                },
                {
                    "ForwardConfig": {
                        "TargetGroupStickinessConfig": {
                            "DurationSeconds": 3600,
                            "Enabled": false
                        },
                        "TargetGroups": [
                            {
                                "TargetGroupArn": "arn:aws:elasticloadbalancing:<REGION>:<ACCOUNT-ID>::targetgroup/TG/DDDD",
                                "Weight": 1
                            }
                        ]
                    },
                    "TargetGroupArn": "arn:aws:elasticloadbalancing:<REGION>:<ACCOUNT-ID>::targetgroup/TG/DDDD",
                    "Type": "forward",
                    "Order": 2
                }

In this example, you can see that requests must be authenticated (order 1)
before being forwarded (order 2) to the configured target group. You can also
see the _OnUnauthenticatedRequest_ configuration, which accepts three options:
_authenticate (default), allow,_ and _deny_.

**1\. Authenticate:** This option should be used for applications that require
the user to log in to display the content. When the user is not logged in, the
load balancer redirects the request to the Identity Provider’s (IdP)
authorization endpoint, and the IdP prompts the user to log in using its user
interface.

**2\. Allow:** This option is useful for Single Page Apps (SPAs). It can be
used if you need to provide multiple views of the webpage for different
audiences such as authenticated and unauthenticated users. For example, if the
user is not logged in, and the requests do not contain claims, then the
backend can provide a general view of the website. If the user is already
logged in, and claims are present in the headers, then the application can
provide a personalized view based on those claims.

**3\. Deny:** This option is for use-cases where you have a specific page or
path that receives asynchronous requests that reload every few seconds, such
as Asynchronous JavaScript and XML (AJAX). In this case, the load balancer
returns an HTTP 401 Unauthorized error to calls that have no authentication
information instead of redirecting the client to the IdP authorization
endpoint. This prevents unauthenticated asynchronous calls to experience an
infinite redirect. Note that if the request contains expired authentication
information, then ALB redirects the client to the IdP authorization endpoint.

In summary, the authenticate option is suitable for applications that need
user authentication to access content, the allow option is helpful for SPAs
that need to provide different views based on authentication status, and the
deny option is useful for handling asynchronous requests that should not be
served if the user is not previously authenticated.

## ALB authentication flow

These are the steps ALB uses OpenID Connect (OIDC) to authenticate users:

![ALB Authentication
flow](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2024/08/15/alb-
auth-2.png) _Authentication flow_  
---  
  
  1. Client sends an HTTPS request to a workload hosted behind an ALB with authentication enabled.
  2. ALB checks the request headers for a session cookie and redirects the user to an IdP authorization endpoint if a session cookie is not present, then the IdP can authenticate the user.
  3. After the user is authenticated, the IdP redirects the user back to the ALB with an _authorization grant code_.
  4. The load balancer presents the _authorization grant code_ to the IdP token endpoint.
  5. The IdP provides the ID token and access token to the ALB.
  6. The ALB sends the access token to the user info endpoint.
  7. The user info endpoint exchanges the access token for user claims.
  8. The ALB redirects to the original Uniform Resource Identifier (URI) with _AWSELBAuthSessionCookie_ and the user requests the new URI with _AWSELBAuthSessionCookie_.
  9. The ALB validates the cookie, and it forwards the user info to target with the `X-AMZN-OIDC-*` HTTP headers set.
  10. The target accepts the request, validates the authentication information, and then sends a response back to the ALB.
  11. The ALB forwards the final response to the client.

All unauthenticated requests goes through steps 1 through 11, while
authenticated requests go only from steps 9 through 11, as long as the
authentication info has not expired. In other words, after the authentication
is completed, the user that sent the correct authentication info ALB gets its
requests forwarded to the configured target in the **ForwardConfig** rule of
the target group.

## Implementing best practices to secure your target application

In step 10 of the authentication flow, the backend target receives the request
from the ALB and provides a response to these requests. Although the ALB only
sends requests to the configured targets, your target may potentially receive
requests from other sources if its configuration allows this to happen.

![Architecture where targets accepting traffic from exclusively from the
ALB](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2024/08/15/alb-
no-direct-access-1.png) _Architecture where targets accepting traffic from
exclusively from the ALB_  
---  
  
To make sure of the security of your application, it is crucial to mitigate
the risk of unauthorized access by following these recommended steps:

  1. Restrict ALB targets to receive traffic only from trusted sources: 
     * Configure the target’s security groups to accept traffic exclusively from the ALB. This can be accomplished by referencing the security group of the ALB when setting the inbound rules for your target security group. By doing so, you effectively restrict access to your targets, thus making sure that only the ALB can initiate connections to your targets.
     * Deploy ALB targets in private subnets without public IP addresses or Elastic IP addresses. This prevents direct access to the targets from the public internet.
  2. Implement [signature validation](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/listener-authenticate-users.html#user-claims-encoding) for the JSON Web Token (JWT) provided in the requests from the ALB, and confirm the `signer` field from the JWT header matches with the Amazon Resource Name (ARN) of your ALB.

These measures help prevent unauthorized access and maintain the overall
security of your application.

The first recommendation is in fact a best practice for any ALB target. It
makes sure that your target is not reachable from external agents that could
potentially bypass the ALB resources and compromise the security of your
application. This way the ALB is wholly responsible for forwarding requests to
your targets.

In the following section we provide more details on how to implement signature
validation and validation of the signer field.

## Implementing JWT validation

When your load balancer successfully authenticates a user, it sends a JWT
containing the authentication information through the _x-amzn-oidc-data_ HTTP
header to the target. JWT validation is crucial for preventing unauthorized
access. ALB forwards JWT-formatted tokens to targets, however it’s important
to note that these are not the **ID token**. Instead, ALB creates a **new
access token** during user authentication and passes only **access tokens**
and **user claims** to the target. The JWT format used by ALB includes a
header, payload, and signature, with the token being base64 URL encoded and
padded. ALB uses **ES256** (ECDSA using P-256 and SHA256) to generate the JWT
signature.

The ALB authentication feature can only be used with HTTPS listeners, making
sure of encrypted traffic between the client and the load balancer. To encrypt
the authentication information between the ALB and the target, you must
configure the target group to use HTTPS. Before enforcing your authorization
based on the user claims included in the JWT payload, we strongly recommend
your target applications verify the signature of the payload and validate that
the `signer` field contains the expected ALB ARN. The load balancer signs the
user claim, using the respective key for the [AWS
Region](https://aws.amazon.com/about-aws/global-infrastructure/regions_az/),
so your application can verify the signature and make sure they were sent by
the correct load balancer .

To start the validation of JWT Tokens you must decode the JWT header and later
on the JWT payload. When decoding the JWT header, its contents are the JSON
object with the following fields:

    
    
    {
       "alg": "algorithm",
       "kid": "12345678-1234-1234-1234-123456789012",
       "signer": "arn:aws:elasticloadbalancing:region-code:account-id:loadbalancer/app/<YOUR-ALB-NAME>/load-balancer-id", 
       "iss": "url",
       "client": "client-id",
       "exp": "expiration"
    }
    

As you can see, the ALB appends its **ARN** in the **signer** field and the
_client_id_ that it uses to connect with the configured IDP while creating the
JWT headers. The signer field helps you to make sure that that that the
headers were signed by the load balancer you configured.

After you have the JWT headers, before decoding the JWT payload, you should
verify the payload signature. To do that you need to retrieve the key ID (kid)
from the JWT header and use it to look up the public key from the endpoint.
The endpoint for each AWS Region is as follows:

`https://public-keys.auth.elb.<REGION>.amazonaws.com/key-id`

The key uses the PEM encoding format, verifying that the signature helps to
make sure that the request hasn’t been tampered. After decoding the JWT
payload, its contents are a JSON object that contains the user claims received
from the IdP user info endpoint.

    
    
    {
      "sub": "12345678-1234-1234-1234-123456789012",
      "email": "email@example.org",
      "username": "my_username",
      "exp": 1686153020,
      "iss": "https://<YOUR ISSUER>/xxxxxxxxx"
    }

Note that the JWT signature verification can only be properly completed if you
have the correct public key. Additionally, to prevent replay of the older
signed header, you should also verify the expiration_time to the JWT payload.

### Below is a summary of the steps involved in the JWT validation:

  1. The target receives the x-amzn-oidc-data HTTP header.
  2. The base64-encoded JWT header present in the x-amzn-oidc-data HTTP header is decoded.
  3. The “signer” value is validated to ensure it matches the expected ALB ARN configured for this target.
  4. The public key is downloaded from the regional endpoint, using the “kid” (Key ID) value.
  5. The signature is validated on the JWT payload, using the downloaded public key.
  6. The JWT payload is validated to ensure it has not expired, by checking the “exp” (expiration) field.

There are multiple libraries in various programming languages that validate
JWT signatures. We provide a sample using the _PyJWT library_ for Python 3.x,
with comments at each step to assist you in building upon it.

### Signature validation code sample using Python 3.x

    
    
    import jwt
    import requests
    import base64
    import json
    
    # Configure the region your workload is running e.g. us-east-1
    region = region-code
    
    # Configure the expected ALB ARN
    expected_alb_arn = 'arn:aws:elasticloadbalancing:region-code:account-id:loadbalancer/app/load-balancer-name/load-balancer-id'
    
    # Store the encoded JWT from the x-amzn-oidc-data HTTP header
    encoded_jwt = headers.dict['x-amzn-oidc-data']
    
    # Step 1: decode the JWT header
    jwt_headers = encoded_jwt.split('.')[0]
    decoded_jwt_headers = base64.b64decode(jwt_headers)
    decoded_jwt_headers = decoded_jwt_headers.decode("utf-8")
    decoded_json = json.loads(decoded_jwt_headers)
    received_alb_arn = decoded_json['signer']
    
    # This compares the ARN you configured in expected_alb_arn with the received_alb_arn.
    assert expected_alb_arn == received_alb_arn, "Invalid Signer"
    # If the ARN is not the expected one it tells "Invalid Signer"
    
    # Step 2: Extract the key id (kid field) from the decoded JSON from the JWT header
    kid = decoded_json['kid']
    
    # Step 3: Retrieve public key from regional endpoint 
    url = 'https://public-keys.auth.elb.' + region + '.amazonaws.com/' + kid
    req = requests.get(url)
    pub_key = req.text
    
    # Step 4: Decode the payload from the encoded JWT by validating the signature
    payload = jwt.decode(encoded_jwt, pub_key, algorithms=['ES256'])
    # If the signature is invalid, it should return an error, such as:
    # Cannot decode JWT token: Signature verification failed
    

## Additional resources

AWS provides a comprehensive set of resources to help you secure your cloud
environment and adhere to security best practices. Check these additional
resources for more information:

  * [Trusted Advisor Check “ALB Security Groups”](https://docs.aws.amazon.com/awssupport/latest/user/security-checks.html#alb-security-group): check if your targets follow the best security practices for security groups configuration.
  * [ALB authentication documentation](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/listener-authenticate-users.html): it provides details on how to configure user authentication for applications deployed behind an ALB.
  * [AWS Well-Architected](https://aws.amazon.com/architecture/well-architected/): a framework to help users build applications optimized for AWS Cloud. Security is one of the pillars covered by the framework. It also provides a tool to help evaluate the current state of your workload.
  * [AWS Trusted Advisor:](https://aws.amazon.com/premiumsupport/technology/trusted-advisor/) provides automated checks of your environment aligned with the Well Architected Framework.
  * [AWS Security Hub:](https://aws.amazon.com/security-hub/) an AWS service with automated security best practice checks integrated with [AWS Config](https://aws.amazon.com/config/). Some of the checks are directly related to the topic of this post: 
    * [Security groups should only allow unrestricted incoming traffic for authorized ports](https://docs.aws.amazon.com/securityhub/latest/userguide/ec2-controls.html#ec2-18)
    * [Security groups should not allow unrestricted access to ports with high risk](https://docs.aws.amazon.com/securityhub/latest/userguide/ec2-controls.html#ec2-19)
  * [Elastic Load Balancing (ELB) best practices guides:](https://aws.github.io/aws-elb-best-practices/) A list of curated best practices when using ALB, focused on Security and Reliability. It [mentions target security groups in alignment](https://aws.github.io/aws-elb-best-practices/security/infrastructure_protection/#target-security-groups) with what is covered in this post.

## Conclusion

In conclusion, securing your target application when using the ALB
authentication feature is critical for maintaining the integrity and security
of your application. By implementing the recommended security measures, such
as restricting target access exclusively to the ALB and validating the JWT
signature and signer field, you can significantly mitigate the risk of
unauthorized access. The JWT validation process makes sure that the user
claims received by your target application are authentic and originate from
the configured ALB. Furthermore, verifying the signer field in the JWT header
confirms that the claims were signed by the expected ALB, providing an
additional layer of security. By following these best practices, you can
enhance the overall security posture of your application and protect it from
potential inadvertent access. Adopting a proactive and comprehensive approach
to security is essential in today’s ever-evolving threat landscape.

_**An update was made on November 25, 2024:** The post has been updated to
include the newly released Trusted Advisor check “ALB Security Groups” as an
Additional Resource._

## About the authors

![](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2024/08/15/lucas-
rolim.jpg)

### Lucas Pellucci Barreto Rolim

Lucas Rolim is a Senior Solutions Architect with Amazon Web Services (AWS),
working in the Application Networking team and based in Sydney, Australia. He
is passionate about assisting customers in making informed decisions while
building on AWS. His primary areas of expertise are Networking and Security.

![](https://d2908q01vomqb2.cloudfront.net/5b384ce32d8cdef02bc3a139d4cac0a22bb029e8/2024/08/15/felipe-
silva.jpg)

### Luis Felipe Silveira da Silva

Luis Felipe is a Principal Solutions Architect in the ELB Team. He works with
a diverse range of load balancing and networking technologies, collaborating
with customers and internal teams to design and optimize workloads, along with
ensuring successful implementation and adoption of EC2 Networking services.

###  Resources

  * [Networking Products](https://aws.amazon.com/products/networking?sc_ichannel=ha&sc_icampaign=acq_awsblogsb&sc_icontent=networking-resources)
  * [Getting Started](https://aws.amazon.com/getting-started?sc_ichannel=ha&sc_icampaign=acq_awsblogsb&sc_icontent=networking-resources)
  * [Amazon CloudFront](https://aws.amazon.com/cloudfront?sc_ichannel=ha&sc_icampaign=acq_awsblogsb&sc_icontent=networking-resources)

* * *

###  Follow

  * [__  Twitter](https://twitter.com/awscloud)
  * [__  Facebook](https://www.facebook.com/amazonwebservices)
  * [__  LinkedIn](https://www.linkedin.com/company/amazon-web-services/)
  * [__  Twitch](https://www.twitch.tv/aws)
  * [__  Email Updates](https://pages.awscloud.com/communication-preferences?sc_ichannel=ha&sc_icampaign=acq_awsblogsb&sc_icontent=news-social)

[ Sign In to the Console
](https://console.aws.amazon.com/console/home?nc1=f_ct&src=footer-signin-
mobile)

###  Learn About AWS

  * [What Is AWS?](https://aws.amazon.com/what-is-aws/?nc1=f_cc)
  * [What Is Cloud Computing?](https://aws.amazon.com/what-is-cloud-computing/?nc1=f_cc)
  * [AWS Accessibility](https://aws.amazon.com/accessibility/?nc1=f_cc)
  * [AWS Inclusion, Diversity & Equity](https://aws.amazon.com/diversity-inclusion/?nc1=f_cc)
  * [What Is DevOps?](https://aws.amazon.com/devops/what-is-devops/?nc1=f_cc)
  * [What Is a Container?](https://aws.amazon.com/containers/?nc1=f_cc)
  * [What Is a Data Lake?](https://aws.amazon.com/what-is/data-lake/?nc1=f_cc)
  * [What is Artificial Intelligence (AI)?](https://aws.amazon.com/what-is/artificial-intelligence/?nc1=f_cc)
  * [What is Generative AI?](https://aws.amazon.com/what-is/generative-ai/?nc1=f_cc)
  * [What is Machine Learning (ML)?](https://aws.amazon.com/what-is/machine-learning/?nc1=f_cc)
  * [AWS Cloud Security](https://aws.amazon.com/security/?nc1=f_cc)
  * [What's New](https://aws.amazon.com/new/?nc1=f_cc)
  * [Blogs](https://aws.amazon.com/blogs/?nc1=f_cc)
  * [Press Releases](https://press.aboutamazon.com/press-releases/aws "Press Releases")

###  Resources for AWS

  * [Getting Started](https://aws.amazon.com/getting-started/?nc1=f_cc)
  * [Training and Certification](https://aws.amazon.com/training/?nc1=f_cc)
  * [AWS Solutions Library](https://aws.amazon.com/solutions/?nc1=f_cc)
  * [Architecture Center](https://aws.amazon.com/architecture/?nc1=f_cc)
  * [Product and Technical FAQs](https://aws.amazon.com/faqs/?nc1=f_dr)
  * [Analyst Reports](https://aws.amazon.com/resources/analyst-reports/?nc1=f_cc)
  * [AWS Partners](https://aws.amazon.com/partners/work-with-partners/?nc1=f_dr)

###  Developers on AWS

  * [Developer Center](https://aws.amazon.com/developer/?nc1=f_dr)
  * [SDKs & Tools](https://aws.amazon.com/developer/tools/?nc1=f_dr)
  * [.NET on AWS](https://aws.amazon.com/developer/language/net/?nc1=f_dr)
  * [Python on AWS](https://aws.amazon.com/developer/language/python/?nc1=f_dr)
  * [Java on AWS](https://aws.amazon.com/developer/language/java/?nc1=f_dr)
  * [PHP on AWS](https://aws.amazon.com/developer/language/php/?nc1=f_cc)
  * [JavaScript on AWS](https://aws.amazon.com/developer/language/javascript/?nc1=f_dr)

###  Help

  * [Contact Us](https://aws.amazon.com/contact-us/?nc1=f_m)
  * [Get Expert Help](https://iq.aws.amazon.com/?utm=mkt.foot/?nc1=f_m)
  * [File a Support Ticket](https://console.aws.amazon.com/support/home/?nc1=f_dr)
  * [AWS re:Post](https://repost.aws/?nc1=f_dr)
  * [Knowledge Center](https://repost.aws/knowledge-center/?nc1=f_dr)
  * [AWS Support Overview](https://aws.amazon.com/premiumsupport/?nc1=f_dr)
  * [Legal](https://aws.amazon.com/legal/?nc1=f_cc)
  * [AWS Careers](https://aws.amazon.com/careers/)

[ Create an AWS Account
](https://portal.aws.amazon.com/gp/aws/developer/registration/index.html?nc1=f_ct&src=default)

[ __](https://twitter.com/awscloud "Twitter")

[ __](https://www.facebook.com/amazonwebservices "Facebook")

[ __](https://www.linkedin.com/company/amazon-web-services/ "Linkedin")

[ __](https://www.instagram.com/amazonwebservices/ "Instagram")

[ __](https://www.twitch.tv/aws "Twitch")

[ __](https://www.youtube.com/user/AmazonWebServices/Cloud/ "YouTube")

[ __](https://aws.amazon.com/podcasts/ "Podcast")

[ __](https://pages.awscloud.com/communication-preferences?trk=homepage
"Email")

Amazon is an Equal Opportunity Employer: _Minority / Women / Disability /
Veteran / Gender Identity / Sexual Orientation / Age._

  * Language
  * [عربي](https://aws.amazon.com/ar/?nc1=h_ls)
  * [Bahasa Indonesia](https://aws.amazon.com/id/?nc1=h_ls)
  * [Deutsch](https://aws.amazon.com/de/?nc1=h_ls)
  * [English](https://aws.amazon.com/?nc1=h_ls)
  * [Español](https://aws.amazon.com/es/?nc1=h_ls)
  * [Français](https://aws.amazon.com/fr/?nc1=h_ls)
  * [Italiano](https://aws.amazon.com/it/?nc1=h_ls)
  * [Português](https://aws.amazon.com/pt/?nc1=h_ls)
  * [Tiếng Việt](https://aws.amazon.com/vi/?nc1=f_ls)
  * [Türkçe](https://aws.amazon.com/tr/?nc1=h_ls)
  * [Ρусский](https://aws.amazon.com/ru/?nc1=h_ls)
  * [ไทย](https://aws.amazon.com/th/?nc1=f_ls)
  * [日本語](https://aws.amazon.com/jp/?nc1=h_ls)
  * [한국어](https://aws.amazon.com/ko/?nc1=h_ls)
  * [中文 (简体)](https://aws.amazon.com/cn/?nc1=h_ls)
  * [中文 (繁體)](https://aws.amazon.com/tw/?nc1=h_ls)

  * [Privacy](https://aws.amazon.com/privacy/?nc1=f_pr)
  * |
  * [Accessibility](https://aws.amazon.com/accessibility/?nc1=f_acc)
  * |
  * [Site Terms](https://aws.amazon.com/terms/?nc1=f_pr)
  * |
  * Cookie Preferences 
  * |
  * © 2024, Amazon Web Services, Inc. or its affiliates. All rights reserved.

